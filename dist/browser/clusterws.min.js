var ClusterWSClient=function(){"use strict";var t;!function(t){t[t.ALL=0]="ALL",t[t.DEBUG=1]="DEBUG",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR"}(t||(t={}));var e=function(){function e(t){this.level=t}return e.prototype.debug=function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];this.level>t.DEBUG||console.log.apply(console,["[36mdebug:[0m"].concat(e.map(function(t){return"object"==typeof t?JSON.stringify(t):t})))},e.prototype.info=function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];this.level>t.INFO||console.log.apply(console,["[32minfo:[0m"].concat(e))},e.prototype.error=function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];this.level>t.ERROR||console.log.apply(console,["[31merror:[0m"].concat(e))},e.prototype.warning=function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];this.level>t.WARN||console.log.apply(console,["[33mwarning:[0m"].concat(e))},e}();var o=function(){function t(t){this.logger=t,this.events={}}return t.prototype.on=function(t,e){if("function"!=typeof e)return this.logger.error("Listener must be a function");this.events[t]=e},t.prototype.emit=function(t){for(var e=[],o=1;o<arguments.length;o++)e[o-1]=arguments[o];var n=this.events[t];n&&n.apply(void 0,e)},t.prototype.exist=function(t){return!!this.events[t]},t.prototype.off=function(t){delete this.events[t]},t.prototype.removeEvents=function(){this.events={}},t}();function n(t,e){var o=e[0],n=e[1],r=e[2];if("e"===o)return t.emitter.emit(n,r)}var r=window.MozWebSocket||window.WebSocket,i=new Uint8Array(["A".charCodeAt(0)]).buffer;return function(){function s(n){if(this.reconnectAttempts=0,this.options={url:n.url,autoConnect:!1!==n.autoConnect,autoReconnect:n.autoReconnect||!1,autoResubscribe:!1!==n.autoResubscribe,autoReconnectOptions:{attempts:n.autoReconnectOptions&&n.autoReconnectOptions.attempts||0,minInterval:n.autoReconnectOptions&&n.autoReconnectOptions.minInterval||500,maxInterval:n.autoReconnectOptions&&n.autoReconnectOptions.maxInterval||2e3},logger:n.loggerOptions&&n.loggerOptions.logger?n.loggerOptions.logger:new e(n.loggerOptions&&n.loggerOptions.level||t.ALL)},!this.options.url)return this.options.logger.error("url must be provided");this.emitter=new o(this.options.logger),this.reconnectAttempts=this.options.autoReconnectOptions.attempts,this.options.autoConnect&&this.connect()}return Object.defineProperty(s.prototype,"OPEN",{get:function(){return this.socket.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"CLOSED",{get:function(){return this.socket.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"readyState",{get:function(){return this.socket?this.socket.readyState:0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"binaryType",{get:function(){return this.socket.binaryType},set:function(t){this.socket.binaryType=t},enumerable:!0,configurable:!0}),s.prototype.connect=function(){var t=this;if(this.isCreated)return this.options.logger.error("Connect event has been called multiple times");this.isCreated=!0,this.socket=new r(this.options.url),this.socket.onopen=function(){t.reconnectAttempts=t.options.autoReconnectOptions.attempts},this.socket.onclose=function(e,o){t.isCreated=!1;var n="number"==typeof e?e:e.code,r="number"==typeof e?o:e.reason;if(t.emitter.emit("close",n,r),t.options.autoReconnect&&1e3!==n&&t.readyState===t.CLOSED&&(0===t.options.autoReconnectOptions.attempts||t.reconnectAttempts>0))return t.reconnectAttempts--,setTimeout(function(){t.connect()},Math.floor(Math.random()*(t.options.autoReconnectOptions.maxInterval-t.options.autoReconnectOptions.minInterval+1)));t.emitter.removeEvents()},this.socket.onmessage=function(e){var o=e;e.data&&(o=e.data),t.parsePing(o,function(){if(t.emitter.exist("message"))return t.emitter.emit("message",o);t.processMessage(o)})},this.socket.onerror=function(e){if(t.emitter.exist("error"))return t.emitter.emit("error",e);t.options.logger.error(e),t.close()}},s.prototype.on=function(t,e){this.emitter.on(t,e)},s.prototype.send=function(t,e,o){return void 0===o&&(o="emit"),void 0===e?this.socket.send(t):this.socket.send(function(t,e,o){var n={emit:["e",t,e],publish:["p",t,e],system:{subscribe:["s","s",e],unsubscribe:["s","u",e],configuration:["s","c",e]}};return"system"===o?JSON.stringify(n[o][t]):JSON.stringify(n[o])}(t,e,o))},s.prototype.close=function(t,e){this.socket.close(t||1e3,e)},s.prototype.processMessage=function(t){try{if(t instanceof Array)return n(this,t);if("string"!=typeof t){var e=new Error("processMessage accepts only string or array types");if(this.emitter.exist("error"))return this.emitter.emit("error",e);throw e}if("["!==t[0]){e=new Error("processMessage received incorrect message");if(this.emitter.exist("error"))return this.emitter.emit("error",e);throw e}return n(this,JSON.parse(t))}catch(e){if(this.emitter.exist("error"))return this.emitter.emit("error",e);throw this.close(),e}},s.prototype.parsePing=function(t,e){var o=this;if(1===t.size||1===t.byteLength){var n=function(t){return 57===new Uint8Array(t)[0]?(o.socket.send(i),o.emitter.emit("ping")):e()};if(t instanceof Blob){var r=new FileReader;return r.onload=function(t){return n(t.srcElement.result)},r.readAsArrayBuffer(t)}return n(t)}return e()},s}()}();
