var ClusterWSClient=function(){"use strict";var t;!function(t){t[t.ALL=0]="ALL",t[t.DEBUG=1]="DEBUG",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR"}(t||(t={}));var e=function(){function e(t){this.level=t}return e.prototype.debug=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.level>t.DEBUG||console.log.apply(console,["[36mdebug:[0m"].concat(e.map(function(t){return"object"==typeof t?JSON.stringify(t):t})))},e.prototype.info=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.level>t.INFO||console.log.apply(console,["[32minfo:[0m"].concat(e))},e.prototype.error=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.level>t.ERROR||console.log.apply(console,["[31merror:[0m"].concat(e))},e.prototype.warning=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.level>t.WARN||console.log.apply(console,["[33mwarning:[0m"].concat(e))},e}();var n=function(){function t(t){this.logger=t,this.events={}}return t.prototype.on=function(t,e){if("function"!=typeof e)return this.logger.error("Listener must be a function");this.events[t]=e},t.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var o=this.events[t];o&&o.apply(void 0,e)},t.prototype.exist=function(t){return!!this.events[t]},t.prototype.off=function(t){delete this.events[t]},t.prototype.removeEvents=function(){this.events={}},t}();function o(t,e){var n=e[0],o=e[1],r=e[2];if("e"===n)return t.emitter.emit(o,r);if("p"===n)for(var i=0,s=(p=Object.keys(r)).length;i<s;i++)for(var c=r[h=p[i]],a=0,u=c.length;a<u;a++)t.channels.channelNewMessage(h,c[a]);if("s"===n&&"s"===o){var p;for(i=0,s=(p=Object.keys(r)).length;i<s;i++){var h=p[i];t.channels.channelSetStatus(h,r[h])}}}var r=function(){function t(t,e,n){this.client=t,this.name=e,this.listener=n,this.READY=1,this.status=0,this.events={},this.client.send("subscribe",[this.name],"system")}return t.prototype.on=function(t,e){this.events[t]=e},t.prototype.publish=function(t){this.status===this.READY&&this.client.send(this.name,t,"publish")},t.prototype.unsubscribe=function(){this.status=0,this.emit("unsubscribed"),this.client.channels.removeChannel(this.name),this.client.send("unsubscribe",this.name,"system")},t.prototype.emit=function(t){var e=this.events[t];e&&e()},t}(),i=function(){function t(t){this.client=t,this.channels={}}return t.prototype.subscribe=function(t,e){if(!this.channels[t]){var n=new r(this.client,t,e);return this.channels[t]=n,n}},t.prototype.getChannelByName=function(t){return this.channels[t]||null},t.prototype.channelNewMessage=function(t,e){var n=this.channels[t];n&&n.status===n.READY&&n.listener(e)},t.prototype.channelSetStatus=function(t,e){var n=this.channels[t];if(n){if(!e)return n.emit("canceled"),this.removeChannel(t);n.status=1,n.emit("subscribed")}},t.prototype.removeChannel=function(t){delete this.channels[t]},t}(),s=window.MozWebSocket||window.WebSocket,c=new Uint8Array(["A".charCodeAt(0)]).buffer;return function(){function r(o){if(this.reconnectAttempts=0,this.options={url:o.url,autoConnect:!1!==o.autoConnect,autoReconnect:o.autoReconnect||!1,autoResubscribe:!1!==o.autoResubscribe,autoReconnectOptions:{attempts:o.autoReconnectOptions&&o.autoReconnectOptions.attempts||0,minInterval:o.autoReconnectOptions&&o.autoReconnectOptions.minInterval||500,maxInterval:o.autoReconnectOptions&&o.autoReconnectOptions.maxInterval||2e3},logger:o.loggerOptions&&o.loggerOptions.logger?o.loggerOptions.logger:new e(o.loggerOptions&&o.loggerOptions.level||t.ALL)},!this.options.url)return this.options.logger.error("url must be provided");this.emitter=new n(this.options.logger),this.channels=new i(this),this.reconnectAttempts=this.options.autoReconnectOptions.attempts,this.options.autoConnect&&this.connect()}return Object.defineProperty(r.prototype,"OPEN",{get:function(){return this.socket.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"CLOSED",{get:function(){return this.socket.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"readyState",{get:function(){return this.socket?this.socket.readyState:0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"binaryType",{get:function(){return this.socket.binaryType},set:function(t){this.socket.binaryType=t},enumerable:!0,configurable:!0}),r.prototype.connect=function(){var t=this;if(this.isCreated)return this.options.logger.error("Connect event has been called multiple times");this.isCreated=!0,this.socket=new s(this.options.url),this.socket.onopen=function(){t.reconnectAttempts=t.options.autoReconnectOptions.attempts},this.socket.onclose=function(e,n){t.isCreated=!1;var o="number"==typeof e?e:e.code,r="number"==typeof e?n:e.reason;if(t.emitter.emit("close",o,r),t.options.autoReconnect&&1e3!==o&&t.readyState===t.CLOSED&&(0===t.options.autoReconnectOptions.attempts||t.reconnectAttempts>0))return t.reconnectAttempts--,setTimeout(function(){t.connect()},Math.floor(Math.random()*(t.options.autoReconnectOptions.maxInterval-t.options.autoReconnectOptions.minInterval+1)));t.emitter.removeEvents()},this.socket.onmessage=function(e){var n=e;e.data&&(n=e.data),t.parsePing(n,function(){if(t.emitter.exist("message"))return t.emitter.emit("message",n);t.processMessage(n)})},this.socket.onerror=function(e){if(t.emitter.exist("error"))return t.emitter.emit("error",e);t.options.logger.error(e),t.close()}},r.prototype.on=function(t,e){this.emitter.on(t,e)},r.prototype.send=function(t,e,n){return void 0===n&&(n="emit"),void 0===e?this.socket.send(t):this.socket.send(function(t,e,n){var o={emit:["e",t,e],publish:["p",t,e],system:{subscribe:["s","s",e],unsubscribe:["s","u",e],configuration:["s","c",e]}};return"system"===n?JSON.stringify(o[n][t]):JSON.stringify(o[n])}(t,e,n))},r.prototype.close=function(t,e){this.socket.close(t||1e3,e)},r.prototype.subscribe=function(t,e){return this.channels.subscribe(t,e)},r.prototype.getChannelByName=function(t){return this.channels.getChannelByName(t)},r.prototype.processMessage=function(t){try{if(t instanceof Array)return o(this,t);if("string"!=typeof t){var e=new Error("processMessage accepts only string or array types");if(this.emitter.exist("error"))return this.emitter.emit("error",e);throw e}if("["!==t[0]){e=new Error("processMessage received incorrect message");if(this.emitter.exist("error"))return this.emitter.emit("error",e);throw e}return o(this,JSON.parse(t))}catch(e){if(this.emitter.exist("error"))return this.emitter.emit("error",e);throw this.close(),e}},r.prototype.parsePing=function(t,e){var n=this;if(1===t.size||1===t.byteLength){var o=function(t){return 57===new Uint8Array(t)[0]?(n.socket.send(c),n.emitter.emit("ping")):e()};if(t instanceof Blob){var r=new FileReader;return r.onload=function(t){return o(t.srcElement.result)},r.readAsArrayBuffer(t)}return o(t)}return e()},r}()}();
